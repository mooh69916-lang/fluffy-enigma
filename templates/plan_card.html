{# Reusable plan card include. Expects `plan` dict with fields: id, amount, profit. Optional: popular, investors, views, rating, funded_pct #}
<article class="plan-card-detailed">
  {# determine currency symbol: user preference > session > default â‚¦ #}
  {% set cs = (user['currency_symbol'] if user and ('currency_symbol' in user) else session.get('currency_symbol')) or 'â‚¦' %}
  {% if (plan is mapping and plan.popular) or (popular|default(false)) %}
    <div class="badge">ðŸ”¥ Most Popular</div>
  {% endif %}
  <header class="plan-head">
    <div class="plan-name"><a href="/plans/{{ plan.id }}">{{ plan.name|default('PLAN') }} â€“ {{ plan.duration|default('2 Day') }}</a></div>
  </header>

  <div class="plan-roi">
    <div class="invest-label">Invest <span class="amount">{{ cs }}{{ '%.2f'|format(plan.display_amount if plan.display_amount is not none else (plan.amount|default(1000))) }}</span></div>
    <div class="gets">Get <span class="get-amount">{{ cs }}{{ '%.2f'|format(plan.display_profit if plan.display_profit is not none else (plan.profit|default(plan.amount + 300))) }}</span></div>
  </div>

  <div class="social-proof">
    <span class="proof"><svg class="icon" viewBox="0 0 24 24" width="16" height="16" aria-hidden="true"><path fill="currentColor" d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg> <span class="count-anim" data-target="{{ plan.investors|default(245) }}">{{ plan.investors|default(245) }}</span></span>
    <span class="proof"><svg class="icon" viewBox="0 0 24 24" width="16" height="16" aria-hidden="true"><path fill="currentColor" d="M12 5c-7 0-11 7-11 7s4 7 11 7 11-7 11-7-4-7-11-7zm0 11a4 4 0 1 1 0-8 4 4 0 0 1 0 8z"/></svg> <span class="count-anim" data-target="{{ plan.views|default(12540) }}">{{ plan.views|default(12540) }}</span></span>
    <span class="proof">
      <span class="stars" aria-hidden="true">
        {%- set rating = (plan.get('rating', 0)|float) -%}
        {%- set full = rating|int -%}
        {%- set half = 1 if (rating - full) >= 0.5 else 0 -%}
        {%- set empty = 5 - full - half -%}
        {%- for i in range(full) %}
          <svg class="star star-full" viewBox="0 0 24 24" width="16" height="16" aria-hidden="true"><path fill="currentColor" d="M12 17.27L18.18 21 16.54 13.97 22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
        {%- endfor %}
        {%- if half %}
          <svg class="star star-half" viewBox="0 0 24 24" width="16" height="16" aria-hidden="true"><defs><linearGradient id="g{{ plan.id }}"><stop offset="50%" stop-color="currentColor"/><stop offset="50%" stop-color="transparent" stop-opacity="0"/></linearGradient></defs><path fill="url(#g{{ plan.id }})" d="M12 17.27L18.18 21 16.54 13.97 22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
        {%- endif %}
        {%- for i in range(empty) %}
          <svg class="star star-empty" viewBox="0 0 24 24" width="16" height="16" aria-hidden="true"><path fill="currentColor" d="M12 17.27L18.18 21 16.54 13.97 22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
        {%- endfor %}
      </span>
      <span class="srating rating-anim" data-target="{{ '%.1f'|format(rating) }}">{{ '%.1f'|format(rating) }}</span>
    </span>
  </div>

  <div class="plan-details">
    <div>Duration: <strong>{{ plan.duration|default('2 Days') }}</strong></div>
    <div>Profit: <strong>{{ cs }}{{ '%.2f'|format(((plan.profit - plan.amount) if (plan.profit is defined and plan.amount is defined) else 300)) }}</strong></div>
    <div>Capital Back: <strong>{{ 'Yes' if plan.capital_back|default(true) else 'No' }}</strong></div>
  </div>

  {% set pct = (plan.funded_pct|default(0.75)) %}
  <div class="funding">
    <div class="funding-row">
      <div class="funding-label">{{ (pct*100)|round(0) }}% Funded</div>
      <div class="funding-bar" aria-hidden="true">
        <div class="funding-fill" style="width:{{ (pct*100)|round(0) }}%"></div>
      </div>
    </div>
  </div>

  {% if plan.countdown_end is defined and plan.countdown_end %}
    <div class="countdown" data-end="{{ plan.countdown_end }}" aria-live="polite">Offer ends in: <span class="countdown-timer">--:--:--</span></div>
  {% endif %}

  <div class="plan-action">
    <a class="btn invest-btn" href="/plans/{{ plan.id }}">ðŸš€ Invest Now</a>
    <a class="whatsapp-btn" href="{{ ADMIN_WHATSAPP_URL if ADMIN_WHATSAPP_URL else ('https://wa.me/16727023654') }}?text=Hello%20I%20am%20interested%20in%20{{ (plan.name|default('plan')|replace(' ', '%20')) }}" target="_blank" rel="noopener noreferrer" aria-label="Contact admin on WhatsApp">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
        <path fill="currentColor" d="M20.52 3.48A11.92 11.92 0 0 0 12.07 0 11.9 11.9 0 0 0 1.43 8.04c-.86 2.56-.4 5.36 1.25 7.48L0 24l8.86-2.33A11.92 11.92 0 0 0 12.07 24c3.18 0 6.15-1.24 8.39-3.48A11.9 11.9 0 0 0 24 8.44 11.9 11.9 0 0 0 20.52 3.48zM12.07 21.6c-1.9 0-3.77-.5-5.4-1.44L4 19.58l.93-2.72A8.77 8.77 0 0 1 3.3 12c0-4.79 3.89-8.68 8.77-8.68 4.79 0 8.69 3.89 8.69 8.68 0 4.79-3.9 8.68-8.69 8.68zM17.2 14.1c-.3-.15-1.8-.9-2.1-1-.3-.1-.5-.15-.7.15-.2.3-.8 1-.98 1.2-.18.2-.36.25-.66.08-.3-.15-1.26-.46-2.4-1.48-.9-.8-1.5-1.8-1.68-2.1-.18-.3-.02-.46.13-.61.14-.14.3-.36.45-.54.15-.18.2-.3.3-.5.1-.2 0-.4-.05-.55-.05-.15-.7-1.7-.96-2.35-.25-.6-.5-.52-.7-.53l-.6-.01c-.2 0-.5.07-.75.35-.25.28-.95.93-.95 2.28 0 1.35.98 2.66 1.12 2.85.15.2 1.9 2.9 4.6 3.95 2.7 1.05 2.7.7 3.18.65.48-.05 1.8-.74 2.05-1.45.25-.7.25-1.3.18-1.45-.07-.15-.3-.25-.6-.4z"/>
      </svg>
    </a>
  </div>
</article>
